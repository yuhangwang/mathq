////////////////////////////////////////////////////////////////////////////////
// File: gaussian_ziggarut.c                                                  //
// Routine(s):                                                                //
//    Gaussian_Variate_Marsaglias_Ziggurat                                    //
////////////////////////////////////////////////////////////////////////////////

#include <math.h>                          // required for abs() and exp()

//                    Required Externally Defined Routines                    //

extern unsigned long  Uniform_32_Bits_Random_Variate( void );
extern double Uniform_0_1_Random_Variate( void );
        
////////////////////////////////////////////////////////////////////////////////
// double Gaussian_Variate_Marsaglias_Ziggurat( void )                        //
//                                                                            //
//  Description:                                                              //
//     This function returns a Gaussian variate with mean 0 and standard      //
//     deviation 1 using Marsaglia's ziggurat method.                         //
//                                                                            //
//  Arguments:                                                                //
//     None                                                                   //
//                                                                            //
//  Return Values:                                                            //
//     A random quantity which has a normal (Gaussian) distribution with      //
//     mean 0 and variance 1.                                                 //
//                                                                            //
//  Example:                                                                  //
//     double x;                                                              //
//                                                                            //
//     x = Gaussian_Variate_Marsaglias_Ziggart();                             //
////////////////////////////////////////////////////////////////////////////////

#define N 256 
static unsigned long kn[N] = {
 4013152258UL, 0000000000UL, 3230394767UL, 3660926891UL, 3844040684UL,
 3945094813UL, 4009015319UL, 4053037231UL, 4085175839UL, 4109658454UL,
 4128923201UL, 4144473941UL, 4157288130UL, 4168028358UL, 4177159544UL,
 4185017460UL, 4191850621UL, 4197846872UL, 4203150821UL, 4207875597UL,
 4212110961UL, 4215929045UL, 4219388470UL, 4222537370UL, 4225415632UL,
 4228056591UL, 4230488323UL, 4232734638UL, 4234815863UL, 4236749458UL,
 4238550500UL, 4240232080UL, 4241805615UL, 4243281112UL, 4244667377UL,
 4245972189UL, 4247202446UL, 4248364287UL, 4249463193UL, 4250504073UL,
 4251491336UL, 4252428956UL, 4253320519UL, 4254169274UL, 4254978170UL,
 4255749889UL, 4256486876UL, 4257191365UL, 4257865403UL, 4258510865UL,
 4259129475UL, 4259722819UL, 4260292360UL, 4260839450UL, 4261365337UL,
 4261871179UL, 4262358050UL, 4262826946UL, 4263278795UL, 4263714461UL,
 4264134749UL, 4264540411UL, 4264932149UL, 4265310621UL, 4265676441UL,
 4266030189UL, 4266372404UL, 4266703597UL, 4267024244UL, 4267334798UL,
 4267635681UL, 4267927293UL, 4268210012UL, 4268484193UL, 4268750174UL,
 4269008272UL, 4269258787UL, 4269502007UL, 4269738199UL, 4269967621UL,
 4270190515UL, 4270407112UL, 4270617631UL, 4270822279UL, 4271021256UL,
 4271214749UL, 4271402937UL, 4271585991UL, 4271764073UL, 4271937338UL,
 4272105935UL, 4272270003UL, 4272429677UL, 4272585085UL, 4272736351UL,
 4272883590UL, 4273026914UL, 4273166431UL, 4273302243UL, 4273434446UL,
 4273563134UL, 4273688396UL, 4273810319UL, 4273928982UL, 4274044465UL,
 4274156843UL, 4274266185UL, 4274372562UL, 4274476038UL, 4274576677UL,
 4274674537UL, 4274769676UL, 4274862149UL, 4274952008UL, 4275039303UL,
 4275124083UL, 4275206392UL, 4275286274UL, 4275363770UL, 4275438921UL,
 4275511764UL, 4275582334UL, 4275650666UL, 4275716792UL, 4275780743UL,
 4275842548UL, 4275902234UL, 4275959827UL, 4276015353UL, 4276068832UL,
 4276120289UL, 4276169741UL, 4276217209UL, 4276262708UL, 4276306256UL,
 4276347867UL, 4276387554UL, 4276425329UL, 4276461204UL, 4276495186UL,
 4276527285UL, 4276557507UL, 4276585859UL, 4276612343UL, 4276636964UL,
 4276659723UL, 4276680620UL, 4276699655UL, 4276716826UL, 4276732129UL,
 4276745559UL, 4276757110UL, 4276766774UL, 4276774543UL, 4276780406UL,
 4276784352UL, 4276786366UL, 4276786434UL, 4276784540UL, 4276780664UL,
 4276774788UL, 4276766890UL, 4276756946UL, 4276744931UL, 4276730818UL,
 4276714578UL, 4276696179UL, 4276675589UL, 4276652771UL, 4276627687UL,
 4276600298UL, 4276570559UL, 4276538426UL, 4276503849UL, 4276466778UL,
 4276427156UL, 4276384928UL, 4276340030UL, 4276292398UL, 4276241962UL,
 4276188651UL, 4276132386UL, 4276073086UL, 4276010663UL, 4275945026UL,
 4275876076UL, 4275803712UL, 4275727822UL, 4275648291UL, 4275564995UL,
 4275477803UL, 4275386576UL, 4275291165UL, 4275191414UL, 4275087154UL,
 4274978208UL, 4274864384UL, 4274745481UL, 4274621281UL, 4274491552UL,
 4274356048UL, 4274214504UL, 4274066635UL, 4273912136UL, 4273750682UL,
 4273581918UL, 4273405468UL, 4273220922UL, 4273027840UL, 4272825745UL,
 4272614121UL, 4272392408UL, 4272159999UL, 4271916232UL, 4271660386UL,
 4271391674UL, 4271109233UL, 4270812119UL, 4270499292UL, 4270169607UL,
 4269821801UL, 4269454472UL, 4269066065UL, 4268654850UL, 4268218891UL,
 4267756019UL, 4267263795UL, 4266739465UL, 4266179907UL, 4265581567UL,
 4264940382UL, 4264251682UL, 4263510073UL, 4262709287UL, 4261841998UL,
 4260899586UL, 4259871831UL, 4258746524UL, 4257508946UL, 4256141186UL,
 4254621211UL, 4252921588UL, 4251007707UL, 4248835230UL, 4246346363UL,
 4243464263UL, 4240084357UL, 4236060396UL, 4231181041UL, 4225128476UL,
 4217400384UL, 4207150466UL, 4192825824UL, 4171211914UL, 4134297471UL,
 4054164659UL
};

static double wn[N] = {
 9.105442928906799926e-10, 5.011490918343926300e-11, 6.663021440433163897e-11,
 7.816998269744804962e-11, 8.733974138237084067e-11, 9.508550507295670581e-11,
 1.018676911964713787e-10, 1.079482810550560750e-10, 1.134918923813933599e-10,
 1.186093617235524148e-10, 1.233792213400728342e-10, 1.278593443164520713e-10,
 1.320937315593051604e-10, 1.361166979433920518e-10, 1.399555750554410326e-10,
 1.436325232516395511e-10, 1.471657856335074574e-10, 1.505705795472007752e-10,
 1.538597453023352983e-10, 1.570442278956281541e-10, 1.601334411641090490e-10,
 1.631355474486050831e-10, 1.660576754228621625e-10, 1.689060919242910201e-10,
 1.716863390603790971e-10, 1.744033447508270137e-10, 1.770615127007728511e-10,
 1.796647962705623557e-10, 1.822167596098112690e-10, 1.847206286249270887e-10,
 1.871793337608620573e-10, 1.895955461392214593e-10, 1.919717082642698965e-10,
 1.943100602567154400e-10, 1.966126623817612229e-10, 1.988814144879960939e-10,
 2.011180728565223644e-10, 2.033242648674316598e-10, 2.055015018175275892e-10,
 2.076511901647182105e-10, 2.097746414274959439e-10, 2.118730809299085510e-10,
 2.139476555515058834e-10, 2.159994406164624086e-10, 2.180294460352917997e-10,
 2.200386217954022492e-10, 2.220278628824944693e-10, 2.239980137029291559e-10,
 2.259498720672504164e-10, 2.278841927866974390e-10, 2.298016909274883738e-10,
 2.317030447616919233e-10, 2.335888984484302293e-10, 2.354598644748320198e-10,
 2.373165258824555775e-10, 2.391594383017266571e-10, 2.409891318142043604e-10,
 2.428061126601297807e-10, 2.446108648066711384e-10, 2.464038513905077905e-10,
 2.481855160468543186e-10, 2.499562841356816443e-10, 2.517165638747168329e-10,
 2.534667473877733159e-10, 2.552072116760586941e-10, 2.569383195193111242e-10,
 2.586604203129130700e-10, 2.603738508465106091e-10, 2.620789360291169471e-10,
 2.637759895651912674e-10, 2.654653145857507464e-10, 2.671472042381877682e-10,
 2.688219422381203019e-10, 2.704898033862960159e-10, 2.721510540532956689e-10,
 2.738059526345348216e-10, 2.754547499778416850e-10, 2.770976897856900631e-10,
 2.787350089939873562e-10, 2.803669381291562490e-10, 2.819937016451030931e-10,
 2.836155182415343953e-10, 2.852326011649637454e-10, 2.868451584936436480e-10,
 2.884533934075588768e-10, 2.900575044445291383e-10, 2.916576857433880744e-10,
 2.932541272751321617e-10, 2.948470150628661398e-10, 2.964365313913105906e-10,
 2.980228550065816206e-10, 2.996061613069017527e-10, 3.011866225248546699e-10,
 3.027644079017539487e-10, 3.043396838546570182e-10, 3.059126141365199560e-10,
 3.074833599899560830e-10, 3.090520802950313906e-10, 3.106189317115023840e-10,
 3.121840688158767389e-10, 3.137476442336540666e-10, 3.153098087670828671e-10,
 3.168707115187502960e-10, 3.184305000113035094e-10, 3.199893203035849753e-10,
 3.215473171034491219e-10, 3.231046338775139403e-10, 3.246614129580885672e-10,
 3.262177956475063641e-10, 3.277739223200825114e-10, 3.293299325219055617e-10,
 3.308859650686637147e-10, 3.324421581416986949e-10, 3.339986493824730164e-10,
 3.355555759856300360e-10, 3.371130747908205029e-10, 3.386712823734642648e-10,
 3.402303351346113623e-10, 3.417903693900629006e-10, 3.433515214589088157e-10,
 3.449139277516369159e-10, 3.464777248579653803e-10, 3.480430496345491977e-10,
 3.496100392927098412e-10, 3.511788314863367697e-10, 3.527495644001091289e-10,
 3.543223768381862923e-10, 3.558974083135166213e-10, 3.574747991379150512e-10,
 3.590546905130618159e-10, 3.606372246225768251e-10, 3.622225447253269089e-10,
 3.638107952501263520e-10, 3.654021218919948807e-10, 3.669966717101415436e-10,
 3.685945932278477699e-10, 3.701960365344283166e-10, 3.718011533894548603e-10,
 3.734100973294336654e-10, 3.750230237771361255e-10, 3.766400901537890390e-10,
 3.782614559943403068e-10, 3.798872830660253640e-10, 3.815177354904701306e-10,
 3.831529798695776488e-10, 3.847931854154579214e-10, 3.864385240846738575e-10,
 3.880891707170907205e-10, 3.897453031796321738e-10, 3.914071025152629876e-10,
 3.930747530975368316e-10, 3.947484427910674291e-10, 3.964283631183028110e-10,
 3.981147094330056154e-10, 3.998076811008674769e-10, 4.015074816877126956e-10,
 4.032143191557757451e-10, 4.049284060685689696e-10, 4.066499598048912393e-10,
 4.083792027825656198e-10, 4.101163626925345233e-10, 4.118616727439846354e-10,
 4.136153719212214625e-10, 4.153777052530649849e-10, 4.171489240955939971e-10,
 4.189292864291277248e-10, 4.207190571703996834e-10, 4.225185085009510331e-10,
 4.243279202128494716e-10, 4.261475800729256436e-10, 4.279777842068128834e-10,
 4.298188375041786363e-10, 4.316710540466480673e-10, 4.335347575600431579e-10,
 4.354102818926951799e-10, 4.372979715217360867e-10, 4.391981820894365247e-10,
 4.411112809718364693e-10, 4.430376478821107350e-10, 4.449776755113278839e-10,
 4.469317702094996613e-10, 4.489003527100816628e-10, 4.508838589013774650e-10,
 4.528827406486212978e-10, 4.548974666708723589e-10, 4.569285234772514211e-10,
 4.589764163674924744e-10, 4.610416705022744383e-10, 4.631248320493470235e-10,
 4.652264694120780754e-10, 4.673471745477357786e-10, 4.694875643835878290e-10,
 4.716482823397624879e-10, 4.738299999687864846e-10, 4.760334187228073030e-10,
 4.782592718607401781e-10, 4.805083265089737519e-10, 4.827813858908468474e-10,
 4.850792917419002891e-10, 4.874029269299451101e-10, 4.897532183013105082e-10,
 4.921311397772871839e-10, 4.945377157278180928e-10, 4.969740246529730293e-10,
 4.994412032067517246e-10, 5.019404506023827638e-10, 5.044730334436307995e-10,
 5.070402910328221050e-10, 5.096436412135047707e-10, 5.122845868140637010e-10,
 5.149647227684410751e-10, 5.176857440016489970e-10, 5.204494541813435759e-10,
 5.232577754527771062e-10, 5.261127592934732384e-10, 5.290165986466179283e-10,
 5.319716415192215071e-10, 5.349804062635785716e-10, 5.380455987996821663e-10,
 5.411701320836163380e-10, 5.443571481845641127e-10, 5.476100434034934181e-10,
 5.509324969531248585e-10, 5.543285038257216935e-10, 5.578024126081558310e-10,
 5.613589691699295055e-10, 5.650033673590856420e-10, 5.687413081061943026e-10,
 5.725790686753357381e-10, 5.765235842369783587e-10, 5.805825445035115743e-10,
 5.847645089092418422e-10, 5.890790447964924827e-10, 5.935368943784346584e-10,
 5.981501780175240204e-10, 6.029326437758949238e-10, 6.078999765424112959e-10,
 6.130701847447973585e-10, 6.184640893658491080e-10, 6.241059497198427799e-10,
 6.300242748398012999e-10, 6.362528910497230061e-10, 6.428323698416320147e-10,
 6.498119733300822135e-10, 6.572523612590606577e-10, 6.652294497176130743e-10,
 6.738400677250260912e-10, 6.832105264088342877e-10, 6.935101188444167298e-10,
 7.049734219372257417e-10, 7.179393740375859787e-10, 7.329250894295984616e-10,
 7.507798848784998032e-10, 7.730547184682976265e-10, 8.030976863953823391e-10,
 8.507987683082485508e-10
};

static double fn[N] = {
 1.000000000000000000e+00, 9.771017012676712404e-01, 9.598790918001063865e-01,
 9.451989534422993663e-01, 9.320600759592301807e-01, 9.199915050393467031e-01,
 9.087264400521305371e-01, 8.980959218983431361e-01, 8.879846607558330585e-01,
 8.783096558089170642e-01, 8.690086880368567129e-01, 8.600336211963312392e-01,
 8.513462584586776908e-01, 8.429156531122039066e-01, 8.347162929868831597e-01,
 8.267268339462210785e-01, 8.189291916037020370e-01, 8.113078743126559060e-01,
 8.038494831709639496e-01, 7.965423304229585965e-01, 7.893761435660241847e-01,
 7.823418326548020551e-01, 7.754313049811867433e-01, 7.686373157984858365e-01,
 7.619533468367949114e-01, 7.553735065070957496e-01, 7.488924472191564949e-01,
 7.425052963401507069e-01, 7.362075981268622637e-01, 7.299952645614758216e-01,
 7.238645334686298100e-01, 7.178119326307215910e-01, 7.118342488782480425e-01,
 7.059285013327538896e-01, 7.000919181365112332e-01, 6.943219161261163365e-01,
 6.886160830046714148e-01, 6.829721616449944305e-01, 6.773880362187731321e-01,
 6.718617198970817742e-01, 6.663913439087498260e-01, 6.609751477766628658e-01,
 6.556114705796970067e-01, 6.502987431108164326e-01, 6.450354808208220427e-01,
 6.398202774530562826e-01, 6.346517992876233119e-01, 6.295287799248363817e-01,
 6.244500155470262045e-01, 6.194143606058340513e-01, 6.144207238889135701e-01,
 6.094680649257731555e-01, 6.045553906974674654e-01, 5.996817526191249127e-01,
 5.948462437679869803e-01, 5.900479963328255085e-01, 5.852861792633709281e-01,
 5.805599961007904741e-01, 5.758686829723532543e-01, 5.712115067352527450e-01,
 5.665877632561639981e-01, 5.619967758145239813e-01, 5.574378936187656228e-01,
 5.529104904258319476e-01, 5.484139632552654314e-01, 5.439477311900258585e-01,
 5.395112342569516745e-01, 5.351039323804572016e-01, 5.307253044036615926e-01,
 5.263748471716840537e-01, 5.220520746723214780e-01, 5.177565172297559591e-01,
 5.134877207473265929e-01, 5.092452459957476321e-01, 5.050286679434679122e-01,
 5.008375751261484266e-01, 4.966715690524893959e-01, 4.925302636438681942e-01,
 4.884132847054576549e-01, 4.843202694266829525e-01, 4.802508659090464597e-01,
 4.762047327195055480e-01, 4.721815384677298297e-01, 4.681809614056932492e-01,
 4.642026890481739949e-01, 4.602464178128425333e-01, 4.563118526787161708e-01,
 4.523987068618483116e-01, 4.485067015072028089e-01, 4.446355653957391998e-01,
 4.407850346658038213e-01, 4.369548525479853944e-01, 4.331447691126521408e-01,
 4.293545410294413390e-01, 4.255839313380218334e-01, 4.218327092294957642e-01,
 4.181006498378480253e-01, 4.143875340408909802e-01, 4.106931482701880545e-01,
 4.070172843294732250e-01, 4.033597392211143622e-01, 3.997203149801970666e-01,
 3.960988185158322493e-01, 3.924950614593154173e-01, 3.889088600187885856e-01,
 3.853400348400770918e-01, 3.817884108733934613e-01, 3.782538172456189833e-01,
 3.747360871378909069e-01, 3.712350576682392612e-01, 3.677505697790323227e-01,
 3.642824681290037835e-01, 3.608306009896477903e-01, 3.573948201457802909e-01,
 3.539749808000766119e-01, 3.505709414814059450e-01, 3.471825639567935090e-01,
 3.438097131468506091e-01, 3.404522570445217014e-01, 3.371100666370059079e-01,
 3.337830158307182743e-01, 3.304709813791634399e-01, 3.271738428136013345e-01,
 3.238914823763910661e-01, 3.206237849569053319e-01, 3.173706380299135117e-01,
 3.141319315963371042e-01, 3.109075581262863656e-01, 3.076974125042919301e-01,
 3.045013919766498540e-01, 3.013193961008029356e-01, 2.981513266966853602e-01,
 2.949970877999616940e-01, 2.918565856170950370e-01, 2.887297284821827505e-01,
 2.856164268155016026e-01, 2.825165930837074587e-01, 2.794301417616377696e-01,
 2.763569892956681140e-01, 2.732970540685769176e-01, 2.702502563658752373e-01,
 2.672165183435611472e-01, 2.641957639972608216e-01, 2.611879191327208806e-01,
 2.581929113376189499e-01, 2.552106699546617066e-01, 2.522411260559419313e-01,
 2.492842124185282852e-01, 2.463398635012636725e-01, 2.434080154227501523e-01,
 2.404886059405004281e-01, 2.375815744312379793e-01, 2.346868618723299136e-01,
 2.318044108243386154e-01, 2.289341654146802558e-01, 2.260760713223802157e-01,
 2.232300757639174689e-01, 2.203961274801519747e-01, 2.175741767243311565e-01,
 2.147641752511735992e-01, 2.119660763070301854e-01, 2.091798346211250275e-01,
 2.064054063978807434e-01, 2.036427493103348762e-01, 2.008918224946565835e-01,
 1.981525865457751389e-01, 1.954250035141342905e-01, 1.927090369035891451e-01,
 1.900046516704649820e-01, 1.873118142238002813e-01, 1.846304924267992802e-01,
 1.819606555995225745e-01, 1.793022745228476723e-01, 1.766553214437350091e-01,
 1.740197700818387699e-01, 1.713955956375059567e-01, 1.687827748012115192e-01,
 1.661812857644820656e-01, 1.635911082323657153e-01, 1.610122234375110914e-01,
 1.584446141559243183e-01, 1.558882647244792271e-01, 1.533431610602628445e-01,
 1.508092906818456942e-01, 1.482866427325745427e-01, 1.457752080059940521e-01,
 1.432749789735134315e-01, 1.407859498144447025e-01, 1.383081164485507214e-01,
 1.358414765712537356e-01, 1.333860296916691335e-01, 1.309417771736443267e-01,
 1.285087222799995378e-01, 1.260868702201858647e-01, 1.236762282015965552e-01,
 1.212768054847902172e-01, 1.188886134429099874e-01, 1.165116656256108144e-01,
 1.141459778278383596e-01, 1.117915681638380117e-01, 1.094484571468116484e-01,
 1.071166677746836470e-01, 1.047962256224869062e-01, 1.024871589419350874e-01,
 1.001894987688098177e-01, 9.790327903886229339e-02, 9.562853671300882713e-02,
 9.336531191269086900e-02, 9.111364806637363963e-02, 8.887359206827579737e-02,
 8.664519445055796478e-02, 8.442850957035337704e-02, 8.222359581320286758e-02,
 8.003051581466306227e-02, 7.784933670209605362e-02, 7.568013035892708091e-02,
 7.352297371398127249e-02, 7.137794905889037996e-02, 6.924514439700677444e-02,
 6.712465382778849664e-02, 6.501657797124285422e-02, 6.292102443775812203e-02,
 6.083810834953986764e-02, 5.876795292093376196e-02, 5.671069010620290379e-02,
 5.466646132488892179e-02, 5.263541827679218400e-02, 5.061772386094776544e-02,
 4.861355321586852525e-02, 4.662309490193036961e-02, 4.464655225129444886e-02,
 4.268414491647443730e-02, 4.073611065594093317e-02, 3.880270740452611650e-02,
 3.688421568856728835e-02, 3.498094146171608537e-02, 3.309321945857852241e-02,
 3.122141719192024890e-02, 2.936593975813331576e-02, 2.752723566960308397e-02,
 2.570580400854889812e-02, 2.390220330579588267e-02, 2.211706270730886605e-02,
 2.035109623004452043e-02, 1.860512127572464577e-02, 1.688008315254316846e-02,
 1.517708830793532698e-02, 1.349745060173988013e-02, 1.184275785790788898e-02,
 1.021497143970147144e-02, 8.616582769398731938e-03, 7.050875471373226984e-03,
 5.522403299250997233e-03, 4.037972593363030822e-03, 2.609072746102162951e-03,
 1.260285930498597564e-03
};

static const double r = 3.6541528853610087716454;
static const double rr = (1.0 / 3.6541528853610087716454);

double Gaussian_Variate_Marsaglias_Ziggurat( void )
{
   unsigned long hz;
   union {
      unsigned long iv;
      unsigned char ib[4];
   } istep;
   char sign;
   double x, y;

   for (;;) {
      hz = Uniform_32_Bits_Random_Variate();
      istep.iv = Uniform_32_Bits_Random_Variate();
      sign = (signed) istep.ib[2];
      x = hz * wn[istep.ib[3]];
      if (sign < 0) x = -x;
      if ( hz < kn[istep.ib[3]] ) return x;
      if (istep.ib[3] == 0) {
         do {
            x = -log( Uniform_0_1_Random_Variate() ) * rr;
            y = -log( Uniform_0_1_Random_Variate() );
         }
         while ( y + y < x * x );
         return ( sign > 0 ) ? r + x : r - x;
      }
      if ( fn[istep.ib[3]] +
            Uniform_0_1_Random_Variate()*(fn[istep.ib[3]-1] - fn[istep.ib[3]])
                                               < exp(-0.5 * x * x) ) return x; 
   }   
}
