////////////////////////////////////////////////////////////////////////////////
// File: ln_factorial.c                                                       //
// Routine(s):                                                                //
//    Ln_Factorial                                                            //
//    xLn_Factorial                                                           //
////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//  Description:                                                              //
//     The functions Ln_Factorial(n) and xLn_Factorial(n) return ln(n!).      //
//     If n < 0, then Ln_Factorial() returns -DBL_MAX and xLn_Factorial()     //
//     returns -LDBL_MAX.                                                     //
////////////////////////////////////////////////////////////////////////////////

#include <math.h>                        // required for logl()
#include <float.h>                       // required for DBL_MAX and LDBL_MAX

//                         Internally Defined Routines                        //

double Ln_Factorial( int n );
long double xLn_Factorial( int n );
static long double xLn_Factorial_Asymptotic_Expansion( int n );

//                         Internally Defined Constants                       //

static long double const ln_factorials[] = {
       0.000000000000000000000e+0L,        //   0!
       0.000000000000000000000e+0L,        //   1!
       6.931471805599453094172e-1L,        //   2!
       1.791759469228055000812e+0L,        //   3!
       3.178053830347945619647e+0L,        //   4!
       4.787491742782045994248e+0L,        //   5!
       6.579251212010100995060e+0L,        //   6!
       8.525161361065414300166e+0L,        //   7!
       1.060460290274525022842e+1L,        //   8!
       1.280182748008146961121e+1L,        //   9!
       1.510441257307551529523e+1L,        //  10!
       1.750230784587388583929e+1L,        //  11!
       1.998721449566188614952e+1L,        //  12!
       2.255216385312342288557e+1L,        //  13!
       2.519122118273868150009e+1L,        //  14!
       2.789927138384089156609e+1L,        //  15!
       3.067186010608067280376e+1L,        //  16!
       3.350507345013688888401e+1L,        //  17!
       3.639544520803305357622e+1L,        //  18!
       3.933988418719949403622e+1L,        //  19!
       4.233561646075348502966e+1L,        //  20!
       4.538013889847690802616e+1L,        //  21!
       4.847118135183522387964e+1L,        //  22!
       5.160667556776437357045e+1L,        //  23!
       5.478472939811231919009e+1L,        //  24!
       5.800360522298051993929e+1L,        //  25!
       6.126170176100200198477e+1L,        //  26!
       6.455753862700633105895e+1L,        //  27!
       6.788974313718153498289e+1L,        //  28!
       7.125703896716800901007e+1L,        //  29!
       7.465823634883016438549e+1L,        //  30!
       7.809222355331531063142e+1L,        //  31!
       8.155795945611503717850e+1L,        //  32!
       8.505446701758151741396e+1L,        //  33!
       8.858082754219767880363e+1L,        //  34!
       9.213617560368709248333e+1L,        //  35!
       9.571969454214320248496e+1L,        //  36!
       9.933061245478742692933e+1L,        //  37!
       1.029681986145138126988e+2L,        //  38!
       1.066317602606434591262e+2L,        //  39!
       1.103206397147573954291e+2L,        //  40!
       1.140342117814617032329e+2L,        //  41!
       1.177718813997450715388e+2L,        //  42!
       1.215330815154386339623e+2L,        //  43!
       1.253172711493568951252e+2L,        //  44!
       1.291239336391272148826e+2L,        //  45!
       1.329525750356163098828e+2L,        //  46!
       1.368027226373263684696e+2L,        //  47!
       1.406739236482342593987e+2L,        //  48!
       1.445657439463448860089e+2L,        //  49!
       1.484777669517730320675e+2L,        //  50!
       1.524095925844973578392e+2L,        //  51!
       1.563608363030787851941e+2L,        //  52!
       1.603311282166309070282e+2L,        //  53!
       1.643201122631951814118e+2L,        //  54!
       1.683274454484276523305e+2L,        //  55!
       1.723527971391628015638e+2L,        //  56!
       1.763958484069973517152e+2L,        //  57!
       1.804562914175437710518e+2L,        //  58!
       1.845338288614494905025e+2L,        //  59!
       1.886281734236715911873e+2L,        //  60!
       1.927390472878449024360e+2L,        //  61!
       1.968661816728899939914e+2L,        //  62!
       2.010093163992815266793e+2L,        //  63!
       2.051681994826411985358e+2L,        //  64!
       2.093425867525368356464e+2L,        //  65!
       2.135322414945632611913e+2L,        //  66!
       2.177369341139542272510e+2L,        //  67!
       2.219564418191303339501e+2L,        //  68!
       2.261905483237275933323e+2L,        //  69!
       2.304390435657769523214e+2L,        //  70!
       2.347017234428182677427e+2L,        //  71!
       2.389783895618343230538e+2L,        //  72!
       2.432688490029827141829e+2L,        //  73!
       2.475729140961868839366e+2L,        //  74!
       2.518904022097231943772e+2L,        //  75!
       2.562211355500095254561e+2L,        //  76!
       2.605649409718632093053e+2L,        //  77!
       2.649216497985528010421e+2L,        //  78!
       2.692910976510198225363e+2L,        //  79!
       2.736731242856937041486e+2L,        //  80!
       2.780675734403661429141e+2L,        //  81!
       2.824742926876303960274e+2L,        //  82!
       2.868931332954269939509e+2L,        //  83!
       2.913239500942703075662e+2L,        //  84!
       2.957666013507606240211e+2L,        //  85!
       3.002209486470141317540e+2L,        //  86!
       3.046868567656687154726e+2L,        //  87!
       3.091641935801469219449e+2L,        //  88!
       3.136528299498790617832e+2L,        //  89!
       3.181526396202093268500e+2L,        //  90!
       3.226634991267261768912e+2L,        //  91!
       3.271852877037752172008e+2L,        //  92!
       3.317178871969284731381e+2L,        //  93!
       3.362611819791984770344e+2L,        //  94!
       3.408150588707990178690e+2L,        //  95!
       3.453794070622668541074e+2L,        //  96!
       3.499541180407702369296e+2L,        //  97!
       3.545390855194408088492e+2L,        //  98!
       3.591342053695753987760e+2L,        //  99!
       3.637393755555634901441e+2L,        // 100!
       3.683544960724047495950e+2L,        // 101!
       3.729794688856890206760e+2L,        // 102!
       3.776141978739186564468e+2L,        // 103!
       3.822585887730600291111e+2L,        // 104!
       3.869125491232175524822e+2L,        // 105!
       3.915759882173296196258e+2L,        // 106!
       3.962488170517915257991e+2L,        // 107!
       4.009309482789157454921e+2L,        // 108!
       4.056222961611448891925e+2L,        // 109!
       4.103227765269373054205e+2L,        // 110!
       4.150323067282496395563e+2L,        // 111!
       4.197508055995447340991e+2L,        // 112!
       4.244781934182570746677e+2L,        // 113!
       4.292143918666515701285e+2L,        // 114!
       4.339593239950148201939e+2L,        // 115!
       4.387129141861211848399e+2L,        // 116!
       4.434750881209189409588e+2L,        // 117!
       4.482457727453846057188e+2L,        // 118!
       4.530248962384961351041e+2L,        // 119!
       4.578123879812781810984e+2L,        // 120!
       4.626081785268749221865e+2L,        // 121!
       4.674121995716081787447e+2L,        // 122!
       4.722243839269805962399e+2L,        // 123!
       4.770446654925856331047e+2L,        // 124!
       4.818729792298879342285e+2L,        // 125!
       4.867092611368394122258e+2L,        // 126!
       4.915534482232980034989e+2L,        // 127!
       4.964054784872176206648e+2L,        // 128!
       5.012652908915792927797e+2L,        // 129!
       5.061328253420348751997e+2L,        // 130!
       5.110080226652360267439e+2L,        // 131!
       5.158908245878223975982e+2L,        // 132!
       5.207811737160441513633e+2L,        // 133!
       5.256790135159950627324e+2L,        // 134!
       5.305842882944334921812e+2L,        // 135!
       5.354969431801695441897e+2L,        // 136!
       5.404169241059976691050e+2L,        // 137!
       5.453441777911548737966e+2L,        // 138!
       5.502786517242855655538e+2L,        // 139!
       5.552202941468948698523e+2L,        // 140!
       5.601690540372730381305e+2L,        // 141!
       5.651248810948742988613e+2L,        // 142!
       5.700877257251342061414e+2L,        // 143!
       5.750575390247102067619e+2L,        // 144!
       5.800342727671307811636e+2L,        // 145!
       5.850178793888391176022e+2L,        // 146!
       5.900083119756178539038e+2L,        // 147!
       5.950055242493819689670e+2L,        // 148!
       6.000094705553274281080e+2L,        // 149!
       6.050201058494236838580e+2L,        // 150!
       6.100373856862386081868e+2L,        // 151!
       6.150612662070848845750e+2L,        // 152!
       6.200917041284773200381e+2L,        // 153!
       6.251286567308909491967e+2L,        // 154!
       6.301720818478101958172e+2L,        // 155!
       6.352219378550597328635e+2L,        // 156!
       6.402781836604080409209e+2L,        // 157!
       6.453407786934350077245e+2L,        // 158!
       6.504096828956552392500e+2L,        // 159!
       6.554848567108890661717e+2L,        // 160!
       6.605662610758735291676e+2L,        // 161!
       6.656538574111059132426e+2L,        // 162!
       6.707476076119126755767e+2L,        // 163!
       6.758474740397368739994e+2L,        // 164!
       6.809534195136374546094e+2L,        // 165!
       6.860654073019939978423e+2L,        // 166!
       6.911834011144107529496e+2L,        // 167!
       6.963073650938140118743e+2L,        // 168!
       7.014372638087370853465e+2L,        // 169!
       7.065730622457873471107e+2L,        // 170!
       7.117147258022900069535e+2L,        // 171!
                                        };
static const int N = sizeof(ln_factorials) / sizeof(long double);
static long double const pi = 3.14159265358979323846264338L;
static const long double log_sqrt_2pi = 9.18938533204672741780329736e-1L;

// Bernoulli numbers B(2),B(4),B(6),...,B(20).  Only B(2),...,B(10) currently //
// used.                                                                      //

static const long double B[] = {   1.0L / (long double)(6 * 2 * 1),
                                  -1.0L / (long double)(30 * 4 * 3),
                                   1.0L / (long double)(42 * 6 * 5),
                                  -1.0L / (long double)(30 * 8 * 7),
                                   5.0L / (long double)(66 * 10 * 9),
                                -691.0L / (long double)(2730 * 12 * 11),
                                   7.0L / (long double)(6 * 14 * 13),
                               -3617.0L / (long double)(510 * 16 * 15),
                               43867.0L / (long double)(796 * 18 * 17),
                             -174611.0L / (long double)(330 * 20 * 19) 
                           };

////////////////////////////////////////////////////////////////////////////////
// double Ln_Factorial( int n )                                               //
//                                                                            //
//  Description:                                                              //
//     This function computes ln(n!).  If n < 0, then -DBL_MAX is returned.   //
//                                                                            //
//  Arguments:                                                                //
//     int    n   Argument of the Factorial function.                         //
//                                                                            //
//  Return Values:                                                            //
//     If n is negative, then -DBL_MAX is returned otherwise ln(n!) is        //
//     returned.                                                              //
//                                                                            //
//  Example:                                                                  //
//     int n;                                                                 //
//     double x;                                                              //
//                                                                            //
//     x = Ln_Factorial( n );                                                 //
////////////////////////////////////////////////////////////////////////////////
double Ln_Factorial(int n) {

             // For a negative argument (n < 0) return -DBL_MAX //

   if ( n < 0 ) return -DBL_MAX;

                       // If n < N then return ln(n!). //

   if ( n < N ) return (double) ln_factorials[n];

            // Otherwise return asymptotic expansion of ln(n!). //

   return (double) xLn_Factorial_Asymptotic_Expansion( n );
}


////////////////////////////////////////////////////////////////////////////////
// long double xLn_Factorial( int n )                                         //
//                                                                            //
//  Description:                                                              //
//     This function computes ln(n!).  If n < 0, then -LDBL_MAX is returned.  //
//                                                                            //
//  Arguments:                                                                //
//     int    n   Argument of the Factorial function.                         //
//                                                                            //
//  Return Values:                                                            //
//     If n is negative, then -LDBL_MAX is returned otherwise ln(n!) is       //
//     returned.                                                              //
//                                                                            //
//  Example:                                                                  //
//     int n;                                                                 //
//     long double x;                                                         //
//                                                                            //
//     x = xLn_Factorial( n );                                                //
////////////////////////////////////////////////////////////////////////////////
long double xLn_Factorial(int n) {

            // For a negative argument (n < 0) return LDBL_MAX //

   if ( n < 0 ) return -LDBL_MAX;

                       // If n < N then return ln(n!). //

   if ( n < N ) return ln_factorials[n];

            // Otherwise return asymptotic expansion of ln(n!). //

   return xLn_Factorial_Asymptotic_Expansion( n );
}


////////////////////////////////////////////////////////////////////////////////
// static long double xLn_Factorial_Asymptotic_Expansion( int n )             //
//                                                                            //
//  Description:                                                              //
//     This function estimates log(n!) by evaluating the asymptotic           //
//     expression:                                                            //
//         ln(n!) ~ ln(2sqrt(2pi)) - (n+1) + (n + 1/2) ln (n+1)               //
//                    Sum B[2j] / [ 2j * (2j-1) * (n+1)^(2j-1) ], summed over //
//     j from 1 to 6 and where B[2j] is the 2j-th Bernoulli number.           //
//                                                                            //
//  Arguments:                                                                //
//     int n  Argument of the ln n!. The argument n must be non-negative.     //
//                                                                            //
//  Return Values:                                                            //
//     ln(n!) where n > N = 171.                                              //
//                                                                            //
//  Example:                                                                  //
//     int n;                                                                 //
//     long double g;                                                         //
//                                                                            //
//     g = xFactorial_Asymptotic_Expansion( n );                              //
////////////////////////////////////////////////////////////////////////////////

static long double xLn_Factorial_Asymptotic_Expansion( int n ) {
   const int  m = 6;
   long double term[6];
   long double sum;
   long double xx = (long double) ((n + 1) * (n + 1));
   long double xj = (long double) (n + 1);
   long double lnfactorial = log_sqrt_2pi - xj + (xj - 0.5L) * logl(xj);
   int i;

   for (i = 0; i < m; i++) { term[i] = B[i] / xj; xj *= xx; }
   sum = term[m-1];
   for (i = m - 2; i >= 0; i--)
      if (fabsl(sum) > fabsl(term[i])) sum = term[i];
      else break;
   for (; i >= 0; i--) sum += term[i]; 
   return lnfactorial + sum;
}
