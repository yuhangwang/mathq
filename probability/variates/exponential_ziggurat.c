////////////////////////////////////////////////////////////////////////////////
// File: exponential_ziggarut.c                                               //
// Routine(s):                                                                //
//    Exponential_Variate_Ziggurat                                            //
////////////////////////////////////////////////////////////////////////////////

#include <math.h>                          // required for abs() and exp()

//                    Required Externally Defined Routines                    //

extern unsigned long  Uniform_32_Bits_Random_Variate( void );
extern double Uniform_0_1_Random_Variate( void );
        
////////////////////////////////////////////////////////////////////////////////
// double Exponential_Variate_Ziggurat( void )                                //
//                                                                            //
//  Description:                                                              //
//     This function returns a Exponential variate with mean 1 using          //
//     Marsaglia's ziggurat method.                                           //
//                                                                            //
//  Arguments:                                                                //
//     None                                                                   //
//                                                                            //
//  Return Values:                                                            //
//     A random quantity which has an Exponential distribution with mean 1.   //
//                                                                            //
//  Example:                                                                  //
//     double x;                                                              //
//                                                                            //
//     x = Exponential_Variate_Ziggart();                                     //
////////////////////////////////////////////////////////////////////////////////

#define N 256 
static unsigned long ke[N] = {
 3801129273UL, 0000000000UL, 2615860924UL, 3279400049UL, 3571300752UL,
 3733536696UL, 3836274812UL, 3906990442UL, 3958562475UL, 3997804264UL,
 4028649213UL, 4053523342UL, 4074002619UL, 4091154507UL, 4105727352UL,
 4118261130UL, 4129155133UL, 4138710916UL, 4147160435UL, 4154685009UL,
 4161428406UL, 4167506077UL, 4173011791UL, 4178022498UL, 4182601930UL,
 4186803325UL, 4190671498UL, 4194244443UL, 4197554582UL, 4200629752UL,
 4203493986UL, 4206168142UL, 4208670408UL, 4211016720UL, 4213221098UL,
 4215295924UL, 4217252177UL, 4219099625UL, 4220846988UL, 4222502074UL,
 4224071896UL, 4225562770UL, 4226980400UL, 4228329951UL, 4229616109UL,
 4230843138UL, 4232014925UL, 4233135020UL, 4234206673UL, 4235232866UL,
 4236216336UL, 4237159604UL, 4238064994UL, 4238934652UL, 4239770563UL,
 4240574564UL, 4241348362UL, 4242093539UL, 4242811568UL, 4243503822UL,
 4244171579UL, 4244816032UL, 4245438297UL, 4246039419UL, 4246620374UL,
 4247182079UL, 4247725394UL, 4248251127UL, 4248760037UL, 4249252839UL,
 4249730206UL, 4250192773UL, 4250641138UL, 4251075867UL, 4251497493UL,
 4251906522UL, 4252303431UL, 4252688672UL, 4253062674UL, 4253425844UL,
 4253778565UL, 4254121205UL, 4254454110UL, 4254777611UL, 4255092022UL,
 4255397640UL, 4255694750UL, 4255983622UL, 4256264513UL, 4256537670UL,
 4256803325UL, 4257061702UL, 4257313014UL, 4257557464UL, 4257795244UL,
 4258026541UL, 4258251531UL, 4258470383UL, 4258683258UL, 4258890309UL,
 4259091685UL, 4259287526UL, 4259477966UL, 4259663135UL, 4259843154UL,
 4260018142UL, 4260188212UL, 4260353470UL, 4260514019UL, 4260669958UL,
 4260821380UL, 4260968374UL, 4261111028UL, 4261249421UL, 4261383632UL,
 4261513736UL, 4261639802UL, 4261761900UL, 4261880092UL, 4261994441UL,
 4262105003UL, 4262211835UL, 4262314988UL, 4262414513UL, 4262510454UL,
 4262602857UL, 4262691764UL, 4262777212UL, 4262859239UL, 4262937878UL,
 4263013162UL, 4263085118UL, 4263153776UL, 4263219158UL, 4263281289UL,
 4263340187UL, 4263395872UL, 4263448358UL, 4263497660UL, 4263543789UL,
 4263586755UL, 4263626565UL, 4263663224UL, 4263696735UL, 4263727099UL,
 4263754314UL, 4263778377UL, 4263799282UL, 4263817020UL, 4263831582UL,
 4263842955UL, 4263851124UL, 4263856071UL, 4263857776UL, 4263856218UL,
 4263851370UL, 4263843206UL, 4263831695UL, 4263816804UL, 4263798497UL,
 4263776735UL, 4263751476UL, 4263722676UL, 4263690284UL, 4263654251UL,
 4263614520UL, 4263571032UL, 4263523724UL, 4263472530UL, 4263417377UL,
 4263358192UL, 4263294892UL, 4263227394UL, 4263155608UL, 4263079437UL,
 4262998781UL, 4262913534UL, 4262823581UL, 4262728804UL, 4262629075UL,
 4262524261UL, 4262414220UL, 4262298801UL, 4262177846UL, 4262051187UL,
 4261918645UL, 4261780032UL, 4261635148UL, 4261483780UL, 4261325704UL,
 4261160681UL, 4260988457UL, 4260808763UL, 4260621313UL, 4260425802UL,
 4260221905UL, 4260009277UL, 4259787550UL, 4259556329UL, 4259315195UL,
 4259063697UL, 4258801357UL, 4258527656UL, 4258242044UL, 4257943926UL,
 4257632664UL, 4257307571UL, 4256967906UL, 4256612870UL, 4256241598UL,
 4255853155UL, 4255446525UL, 4255020608UL, 4254574202UL, 4254106002UL,
 4253614578UL, 4253098370UL, 4252555662UL, 4251984571UL, 4251383021UL,
 4250748722UL, 4250079132UL, 4249371435UL, 4248622490UL, 4247828790UL,
 4246986404UL, 4246090910UL, 4245137315UL, 4244119963UL, 4243032411UL,
 4241867296UL, 4240616155UL, 4239269214UL, 4237815118UL, 4236240596UL,
 4234530035UL, 4232664930UL, 4230623176UL, 4228378137UL, 4225897409UL,
 4223141146UL, 4220059768UL, 4216590757UL, 4212654085UL, 4208145538UL,
 4202926710UL, 4196809522UL, 4189531420UL, 4180713890UL, 4169789475UL,
 4155865042UL, 4137444620UL, 4111806704UL, 4073393724UL, 4008685917UL,
 3873074895UL
};

static double we[N] = {
 2.024955458503926573e-09, 1.486674039973958400e-11, 2.440961719626099318e-11,
 3.196880708914571541e-11, 3.844677064665321214e-11, 4.422820397243666877e-11,
 4.951644470704892946e-11, 5.443358865093335888e-11, 5.905944001532924464e-11,
 6.344942037911747567e-11, 6.764381087646613637e-11, 7.167294497483709668e-11,
 7.556032319946915042e-11, 7.932458097693738455e-11, 8.298078557904680198e-11,
 8.654132143825242793e-11, 9.001651265218858976e-11, 9.341507193080111464e-11,
 9.674443155535426949e-11, 1.000109920803018138e-10, 1.032203124076018490e-10,
 1.063772572510458326e-10, 1.094861130887105720e-10, 1.125506804449163023e-10,
 1.155743481401986437e-10, 1.185601536286191441e-10, 1.215108324755299001e-10,
 1.244288592685866528e-10, 1.273164817046632817e-10, 1.301757491919075318e-10,
 1.330085370067015848e-10, 1.358165668204357564e-10, 1.386014242403916069e-10,
 1.413645738783061625e-10, 1.441073723591111559e-10, 1.468310796035199895e-10,
 1.495368686561791773e-10, 1.522258342820372558e-10, 1.548990005144566657e-10,
 1.575573273071840823e-10, 1.602017164169225344e-10, 1.628330166226328961e-10,
 1.654520283708478567e-10, 1.680595079224456333e-10, 1.706561710649090934e-10,
 1.732426964446224133e-10, 1.758197285658640085e-10, 1.783878804965492835e-10,
 1.809477363152267504e-10, 1.834998533291493659e-10, 1.860447640892788492e-10,
 1.885829782247122066e-10, 1.911149841161473941e-10, 1.936412504255478001e-10,
 1.961622274970564255e-10, 1.986783486423953586e-10, 2.011900313224189904e-10,
 2.036976782351326788e-10, 2.062016783193108348e-10, 2.087024076818234032e-10,
 2.112002304558854099e-10, 2.136954995966621068e-10, 2.161885576199766110e-10,
 2.186797372892645606e-10, 2.211693622553899418e-10, 2.236577476534683023e-10,
 2.261452006604298901e-10, 2.286320210166888264e-10, 2.311185015149592586e-10,
 2.336049284589703595e-10, 2.360915820945746050e-10, 2.385787370155141236e-10,
 2.410666625459047383e-10, 2.435556231013137267e-10, 2.460458785301427920e-10,
 2.485376844368800878e-10, 2.510312924886524451e-10, 2.535269507063895604e-10,
 2.560249037418043376e-10, 2.585253931412965592e-10, 2.610286575977994615e-10,
 2.635349331915096086e-10, 2.660444536203688228e-10, 2.685574504211020670e-10,
 2.710741531815563888e-10, 2.735947897450327336e-10, 2.761195864072540673e-10,
 2.786487681065693421e-10, 2.811825586079529681e-10, 2.837211806813232386e-10,
 2.862648562746702601e-10, 2.888138066824540623e-10, 2.913682527097064327e-10,
 2.939284148322454057e-10, 2.964945133533890126e-10, 2.990667685575346801e-10,
 3.016454008609523814e-10, 3.042306309601231359e-10, 3.068226799779395918e-10,
 3.094217696080720803e-10, 3.120281222577915957e-10, 3.146419611895305380e-10,
 3.172635106614526536e-10, 3.198929960672953674e-10, 3.225306440757405291e-10,
 3.251766827695634476e-10, 3.278313417848049084e-10, 3.304948524502066024e-10,
 3.331674479271470129e-10, 3.358493633503122693e-10, 3.385408359693347539e-10,
 3.412421052916313153e-10, 3.439534132266727878e-10, 3.466750042319171133e-10,
 3.494071254606397111e-10, 3.521500269118968299e-10, 3.549039615828604450e-10,
 3.576691856237668299e-10, 3.604459584957252507e-10, 3.632345431316382989e-10,
 3.660352061004912205e-10, 3.688482177752742241e-10, 3.716738525048091857e-10,
 3.745123887897604325e-10, 3.773641094631184178e-10, 3.802293018754551200e-10,
 3.831082580852609608e-10, 3.860012750546849642e-10, 3.889086548510128439e-10,
 3.918307048542317364e-10, 3.947677379710454742e-10, 3.977200728557206618e-10,
 4.006880341381614663e-10, 4.036719526596300288e-10, 4.066721657165498323e-10,
 4.096890173128513241e-10, 4.127228584213426794e-10, 4.157740472546139278e-10,
 4.188429495460098595e-10, 4.219299388412363227e-10, 4.250353968011958575e-10,
 4.281597135166822464e-10, 4.313032878355996606e-10, 4.344665277034108520e-10,
 4.376498505175604594e-10, 4.408536834966642162e-10, 4.440784640653028898e-10,
 4.473246402553114289e-10, 4.505926711245093294e-10, 4.538830271938779779e-10,
 4.571961909042550346e-10, 4.605326570936851740e-10, 4.638929334966411115e-10,
 4.672775412664092879e-10, 4.706870155220213527e-10, 4.741219059212062491e-10,
 4.775827772609388607e-10, 4.810702101072705128e-10, 4.845848014562448651e-10,
 4.881271654278307139e-10, 4.916979339949418352e-10, 4.952977577497642427e-10,
 4.989273067097742211e-10, 5.025872711660074254e-10, 5.062783625763315866e-10,
 5.100013145066844123e-10, 5.137568836234657970e-10, 5.175458507405213086e-10,
 5.213690219244241510e-10, 5.252272296620577213e-10, 5.291213340948230345e-10,
 5.330522243241475493e-10, 5.370208197933574836e-10, 5.410280717513981407e-10,
 5.450749648043500931e-10, 5.491625185611977850e-10, 5.532917893808662939e-10,
 5.574638722281573176e-10, 5.616799026468933640e-10, 5.659410588593268556e-10,
 5.702485640016966247e-10, 5.746036885067273363e-10, 5.790077526448782724e-10,
 5.834621292372685778e-10, 5.879682465544501188e-10, 5.925275914165820214e-10,
 5.971417125121004343e-10, 6.018122239536933350e-10, 6.065408090923064245e-10,
 6.113292246120489699e-10, 6.161793049312684199e-10, 6.210929669377550210e-10,
 6.260722150890631975e-10, 6.311191469123422564e-10, 6.362359589419096573e-10,
 6.414249531371391765e-10, 6.466885438281477441e-10, 6.520292652423349664e-10,
 6.574497796711594545e-10, 6.629528863437447761e-10, 6.685415310821347545e-10,
 6.742188168224277173e-10, 6.799880150968070761e-10, 6.858525785838825721e-10,
 6.918161548490379119e-10, 6.978826014129749257e-10, 7.040560023057453271e-10,
 7.103406862857414990e-10, 7.167412469289476331e-10, 7.232625648239219251e-10,
 7.299098321433273937e-10, 7.366885799043750063e-10, 7.436047082795390741e-10,
 7.506645203768891566e-10, 7.578747599782539026e-10, 7.652426538055458131e-10,
 7.727759589838675963e-10, 7.804830164881679258e-10, 7.883728115028473060e-10,
 7.964550417966955652e-10, 8.047401954263357361e-10, 8.132396393395169132e-10,
 8.219657207674681824e-10, 8.309318836890946623e-10, 8.401528031399728812e-10,
 8.496445407534143536e-10, 8.594247256958435632e-10, 8.695127661432599501e-10,
 8.799300977056072794e-10, 8.907004768313692740e-10, 9.018503293393899220e-10,
 9.134091670009050505e-10, 9.254100887742332371e-10, 9.378903882223964931e-10,
 9.508922953177936061e-10, 9.644638899862885304e-10, 9.786602374481000894e-10,
 9.935448133101142452e-10, 1.009191311969718200e-09, 1.025685969151922730e-09,
 1.043130584649839950e-09, 1.061646514969726920e-09, 1.081380035127533015e-09,
 1.102509674756261812e-09, 1.125256470643242958e-09, 1.149898647773370958e-09,
 1.176793242334691974e-09, 1.206409018789767530e-09, 1.239378588682599043e-09,
 1.276584953890662378e-09, 1.319313926495153862e-09, 1.369543447111593512e-09,
 1.430549813847167662e-09, 1.508365034552423716e-09, 1.616085327551051127e-09,
 1.792124814850056944e-09
};

static double fe[N] = {
 1.000000000000000000e+00, 9.381436808621746792e-01, 9.004699299257464380e-01,
 8.717043323812036368e-01, 8.477855006239896210e-01, 8.269932966430503340e-01,
 8.084216515230083802e-01, 7.915276369724956552e-01, 7.759568520401155968e-01,
 7.614633888498962486e-01, 7.478686219851951073e-01, 7.350380924314235152e-01,
 7.228676595935720069e-01, 7.112747608050759788e-01, 7.001926550827881671e-01,
 6.895664961170779889e-01, 6.793505722647653874e-01, 6.695063167319247768e-01,
 6.600008410789997418e-01, 6.508058334145710489e-01, 6.418967164272660701e-01,
 6.332519942143660797e-01, 6.248527387036659260e-01, 6.166821809152076233e-01,
 6.087253820796220652e-01, 6.009689663652322474e-01, 5.934009016917334152e-01,
 5.860103184772680276e-01, 5.787873586028450306e-01, 5.717230486648257900e-01,
 5.648091929124002244e-01, 5.580382822625874813e-01, 5.514034165406413168e-01,
 5.448982376724396367e-01, 5.385168720028618660e-01, 5.322538802630432694e-01,
 5.261042139836197260e-01, 5.200631773682335683e-01, 5.141263938147485579e-01,
 5.082897764106428349e-01, 5.025495018413476929e-01, 4.969019872415495530e-01,
 4.913438695940325550e-01, 4.858719873418849356e-01, 4.804833639304542301e-01,
 4.751751930373773830e-01, 4.699448252839599984e-01, 4.647897562504261807e-01,
 4.597076156421376867e-01, 4.546961574746154805e-01, 4.497532511627549892e-01,
 4.448768734145485160e-01, 4.400651008423538750e-01, 4.353161032156365976e-01,
 4.306281372884588392e-01, 4.259995411430343574e-01, 4.214287289976165963e-01,
 4.169141864330028946e-01, 4.124544659971611677e-01, 4.080481831520323824e-01,
 4.036940125305302674e-01, 3.993906844752310788e-01, 3.951369818332901534e-01,
 3.909317369847971072e-01, 3.867738290841376811e-01, 3.826621814960098211e-01,
 3.785957594095808109e-01, 3.745735676159021519e-01, 3.705946484351459942e-01,
 3.666580797815141489e-01, 3.627629733548177733e-01, 3.589084729487497620e-01,
 3.550937528667874592e-01, 3.513180164374833468e-01, 3.475804946216369857e-01,
 3.438804447045024301e-01, 3.402171490667800456e-01, 3.365899140286775814e-01,
 3.329980687618089671e-01, 3.294409642641363309e-01, 3.259179723935561982e-01,
 3.224284849560891429e-01, 3.189719128449572377e-01, 3.155476852271289363e-01,
 3.121552487741795695e-01, 3.087940669345601679e-01, 3.054636192445902354e-01,
 3.021634006756935289e-01, 2.988929210155817710e-01, 2.956517042812612095e-01,
 2.924392881618925877e-01, 2.892552234896777331e-01, 2.860990737370768467e-01,
 2.829704145387807601e-01, 2.798688332369728992e-01, 2.767939284485173446e-01,
 2.737453096528029830e-01, 2.707225967990600317e-01, 2.677254199320448181e-01,
 2.647534188350622021e-01, 2.618062426893629524e-01, 2.588835497490162168e-01,
 2.559850070304153802e-01, 2.531102900156294817e-01, 2.502590823688623097e-01,
 2.474310756653276389e-01, 2.446259691318921090e-01, 2.418434693988772276e-01,
 2.390832902624491700e-01, 2.363451524570596471e-01, 2.336287834374333395e-01,
 2.309339171696274217e-01, 2.282602939307167067e-01, 2.256076601166840650e-01,
 2.229757680581201805e-01, 2.203643758433594972e-01, 2.177732471487005327e-01,
 2.152021510753786779e-01, 2.126508619929782752e-01, 2.101191593889882591e-01,
 2.076068277242220421e-01, 2.051136562938377088e-01, 2.026394390937090193e-01,
 2.001839746919112773e-01, 1.977470661050988646e-01, 1.953285206795632232e-01,
 1.929281499767713387e-01, 1.905457696631954001e-01, 1.881811994042543048e-01,
 1.858342627621971150e-01, 1.835047870977674615e-01, 1.811926034754962949e-01,
 1.788975465724783124e-01, 1.766194545904948958e-01, 1.743581691713534879e-01,
 1.721135353153200570e-01, 1.698854013025276651e-01, 1.676736186172501932e-01,
 1.654780418749360092e-01, 1.632985287519018079e-01, 1.611349399175920318e-01,
 1.589871389693142057e-01, 1.568549923693652201e-01, 1.547383693844680731e-01,
 1.526371420274428615e-01, 1.505511850010399035e-01, 1.484803756438667922e-01,
 1.464245938783449379e-01, 1.443837221606347647e-01, 1.423576454324722004e-01,
 1.403462510748624421e-01, 1.383494288635802141e-01, 1.363670709264288584e-01,
 1.343990717022136308e-01, 1.324453279013875202e-01, 1.305057384683307822e-01,
 1.285802045452281787e-01, 1.266686294375106652e-01, 1.247709185808309658e-01,
 1.228869795095451350e-01, 1.210167218266748373e-01, 1.191600571753276847e-01,
 1.173168992115555706e-01, 1.154871635786335366e-01, 1.136707678827443130e-01,
 1.118676316700562973e-01, 1.100776764051853903e-01, 1.083008254510337987e-01,
 1.065370040500016622e-01, 1.047861393065701693e-01, 1.030481601712577155e-01,
 1.013229974259536359e-01, 9.961058367063712883e-02, 9.791085331149219962e-02,
 9.622374255043280010e-02, 9.454918937605585373e-02, 9.288713355604354652e-02,
 9.123751663104016206e-02, 8.960028191003286453e-02, 8.797537446727021930e-02,
 8.636274114075691229e-02, 8.476233053236812539e-02, 8.317409300963238036e-02,
 8.159798070923742093e-02, 8.003394754231991003e-02, 7.848194920160642605e-02,
 7.694194317048051010e-02, 7.541388873405840845e-02, 7.389774699236474631e-02,
 7.239348087570874303e-02, 7.090105516237182843e-02, 6.942043649872875168e-02,
 6.795159342193660777e-02, 6.649449638533977905e-02, 6.504911778675375504e-02,
 6.361543199980733108e-02, 6.219341540854099615e-02, 6.078304644547963605e-02,
 5.938430563342026449e-02, 5.799717563120065910e-02, 5.662164128374287444e-02,
 5.525768967669703832e-02, 5.390531019604608511e-02, 5.256449459307168960e-02,
 5.123523705512627983e-02, 4.991753428270637495e-02, 4.861138557337949440e-02,
 4.731679291318154871e-02, 4.603376107617516676e-02, 4.476229773294328069e-02,
 4.350241356888818330e-02, 4.225412241331623141e-02, 4.101744138041482082e-02,
 3.979239102337412267e-02, 3.857899550307485962e-02, 3.737728277295936013e-02,
 3.618728478193141975e-02, 3.500903769739741107e-02, 3.384258215087432904e-02,
 3.268796350895953332e-02, 3.154523217289360550e-02, 3.041444391046660549e-02,
 2.929566022463739402e-02, 2.818894876397863442e-02, 2.709438378095579843e-02,
 2.601204664513421808e-02, 2.494202641973178298e-02, 2.388442051155817035e-02,
 2.283933540638523883e-02, 2.180688750428358213e-02, 2.078720407257811760e-02,
 1.978042433800974174e-02, 1.878670074469602950e-02, 1.780620041091136057e-02,
 1.683910682603994636e-02, 1.588562183997316249e-02, 1.494596801169114808e-02,
 1.402039140318193733e-02, 1.310916493125499107e-02, 1.221259242625538066e-02,
 1.133101359783459749e-02, 1.046481018102997949e-02, 9.614413642502209409e-03,
 8.780314985808975235e-03, 7.963077438017039241e-03, 7.163353183634984143e-03,
 6.381905937319179443e-03, 5.619642207205483172e-03, 4.877655983542392581e-03,
 4.157295120833795253e-03, 3.460264777836903986e-03, 2.788798793574075964e-03,
 2.145967743718906179e-03, 1.536299780301572383e-03, 9.672692823271745289e-04,
 4.541343538414967555e-04
};

static const double r = 7.697117470131049714;

double Exponential_Variate_Ziggurat( void )
{
   union {
      unsigned long v;
      unsigned char b[4];
   } j;
   double x;

   for (;;) {
      j.v = Uniform_32_Bits_Random_Variate();
      if ( j.v < ke[j.b[0]] ) return x = j.v * we[j.b[0]];
      if (j.b[0] == 0) return r - log(Uniform_0_1_Random_Variate());
      x = j.v * we[j.b[0]];
      if ( fe[j.b[0]] + Uniform_0_1_Random_Variate()
                          * (fe[j.b[0]-1] - fe[j.b[0]]) < exp(-x) ) return x; 
   }   
}
